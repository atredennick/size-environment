################################################################################
##  anomaly_analysis.R: R script to fit random intercept and random intercept/
##  slope models for growth and survival, then uses the models to calculate
##  yearly anomalies for large and small plants. These anomalies define the
##  impact of the random year effects, and help distinguish where size-dependent
##  environmental responses are operating.
##
## -----------------------------------------------------------------------------
##  Created by: Andrew Tredennick (atredenn@gmail.com)
##              Brittany Teller
##              Stephen Ellner
##              Giles Hooker
##
##  Date created: December 5, 2017
################################################################################
####
####  LOAD LIBRARIES -----------------------------------------------------------
####
library(tidyverse) # Data science packages
library(dplyr)     # Data summarizing and manipulation functions
library(lme4)      # Fitting mixed-effects models
library(boot)      # Bootstrapping capabilities
library(merTools)  # Post-hoc analyses of mixed-effects models
library(RLRsim)    # Testing mixed-effects models
####
####  SET DIRECTORIES ----------------------------------------------------------
####
mainDir   <- root
utilDir   <- paste0(mainDir, "/size_by_year_models/utilities")
datadrivs <- "../data/"
outDir    <- paste0(mainDir, "/size_by_year_models/results/")
source(paste(utilDir,"/fetchDemoData.R", sep="")) # fetch data function
source(paste0(utilDir,"/TrimQuads_BT.R")) # Distinguish seedlings (rising 2yo) function
####
####  DEFINE STATE AND SPECIES DATAFRAME ---------------------------------------
####
states  <- c(rep("Idaho",4),
rep("Montana",4),
rep("Arizona",2),
rep("NewMexico",2),
rep("Kansas",3))
species <- c("ARTR","HECO","POSE","PSSP",
"BOGR","HECO","PASM","POSE",
"BOER","BORO",
"BOER","SPFL",
"ANGE","BOCU","BOHI")
state_species <- data.frame(state = states, species = species)
####
####  FIT GROWTH MODELS AND CALCULATE ANOMALIES --------------------------------
####
##  Define empty storage objects
rye_year_anoms <- {}
rye_sxy_anoms  <- {}
mod_comp_all   <- {}
source(paste(utilDir,"/fetchDemoData.R", sep="")) # fetch data function
####
####  SET DIRECTORIES ----------------------------------------------------------
####
mainDir   <- root
utilDir   <- paste0(mainDir, "/size_by_year_models/utilities")
root <- getwd()  # set root directory to this location
####
####  SET DIRECTORIES ----------------------------------------------------------
####
mainDir   <- root
utilDir   <- paste0(mainDir, "/size_by_year_models/utilities")
datadrivs <- "../data/"
outDir    <- paste0(mainDir, "/size_by_year_models/results/")
source(paste(utilDir,"/fetchDemoData.R", sep="")) # fetch data function
source(paste0(utilDir,"/TrimQuads_BT.R")) # Distinguish seedlings (rising 2yo) function
setwd("~/Repos/size-environment/code/size_by_year_models")
root <- getwd()
####
####  SET DIRECTORIES ----------------------------------------------------------
####
mainDir   <- root
utilDir   <- paste0(mainDir, "/size_by_year_models/utilities")
datadrivs <- "../data/"
outDir    <- paste0(mainDir, "/size_by_year_models/results/")
source(paste(utilDir,"/fetchDemoData.R", sep="")) # fetch data function
setwd("~/Repos/size-environment/code")
root <- getwd()  # set root directory to this location
####
####  SET DIRECTORIES ----------------------------------------------------------
####
mainDir   <- root
utilDir   <- paste0(mainDir, "/size_by_year_models/utilities")
datadrivs <- "../data/"
outDir    <- paste0(mainDir, "/size_by_year_models/results/")
source(paste(utilDir,"/fetchDemoData.R", sep="")) # fetch data function
source(paste0(utilDir,"/TrimQuads_BT.R")) # Distinguish seedlings (rising 2yo) function
states  <- c(rep("Idaho",4),
rep("Montana",4),
rep("Arizona",2),
rep("NewMexico",2),
rep("Kansas",3))
species <- c("ARTR","HECO","POSE","PSSP",
"BOGR","HECO","PASM","POSE",
"BOER","BORO",
"BOER","SPFL",
"ANGE","BOCU","BOHI")
state_species <- data.frame(state = states, species = species)
##  Define empty storage objects
rye_year_anoms <- {}
rye_sxy_anoms  <- {}
mod_comp_all   <- {}
## Loop over state-species
i = 1
##  Set data directory
do_state   <- state_species[i, "state"]
do_species <- state_species[i, "species"]
data_dir   <- paste0(datadrivs, do_state)
## Import demographic data
WEEKset <- FALSE
